<?phpclass Hero{	var $id;        var $nom;	var $niveau;	var $xp;        var $classe;        var $etat; // 1 , en defense sur une case, 2 en déplacement 3 EN COMBAT        var $temps; // Temps avant fin de l'action        var $X;        var $Y;        var $map;        var $garnison;        var $idCompte;        var $idAlliance;		function load($id){	  if($id>0){		  $sql = $GLOBALS["db"]->query('SELECT * FROM j_hero WHERE id = '.$id);		}else{		  return false;		}                if(mysql_num_rows($sql) == 0) {                  //echo 'Le héro n\'existe plus !';                  return false;                }else{ // OBJET CHARGE                    $donnees = mysql_fetch_array($sql);                    $this->id = $donnees['id'];                    $this->idCompte = $donnees['idCompte'];                    $this->idAlliance = $donnees['idAlliance'];                    $this->nom = $donnees['nom'];                    $this->niveau = $donnees['niveau'];                    $this->xp = $donnees['xp'];                    $this->classe = $donnees['classe'];                    $this->etat = $donnees['etat'];                    $this->X = $donnees['X'];                    $this->Y = $donnees['Y'];                    $this->map = $donnees['map'];                    $this->idCompte = $donnees['idCompte'];                    $this->garnison = unserialize($donnees['garnison']);                    $this->temps = $donnees['temps'];                    $this->etat = $donnees['etat'];                    $this->temps = $donnees['temps'];                    if(!is_object($this->garnison)){                      $this->garnison = new Garnison();                      $this->garnison->initCaracs();                      $this->garnison->genererStats();                      $this->save();                    }                    if(is_object($this->garnison) AND $this->garnison->xp<100){                      $this->garnison = new Garnison();                      $this->garnison->initCaracs();                      $this->garnison->genererStats();                      $this->save();                    }                    if($this->temps <= time() AND $this->etat == 2){                      //echo 'FAIS';                      $this->etat = 1;                      $this->save();                          $case = new CaseObject($this->X,$this->Y,$this->map);                          $case->verifHero();                          $this->load($this->id);                    }                    //  print_r($this->etat);                    //$this->garnison->AjoutUnite(6,15);                    //$this->save();                    return true;                }	}          function save(){                    $garnison = serialize($this->garnison);          $sql = "UPDATE j_hero SET          nom = '".$this->nom."',          niveau = '".$this->niveau."',          idAlliance = '".$this->idAlliance."',          xp = '".$this->xp."',          classe = '".$this->classe."',          etat = '".$this->etat."',          temps = '".$this->temps."',          X = '".$this->X."',          Y = '".$this->Y."',          map = '".$this->map."',          garnison = '".$garnison."'          WHERE `id` = '".$this->id."' ;";                    $GLOBALS['db']->query($sql);  }    function insert($idCompte,$idAlliance,$nom,$map)  {    $etat=1;    $garnison = new Garnison();    $garnison->initCaracs();    $garnison=serialize($garnison);    $sql = "INSERT INTO j_hero(idCompte,idAlliance,nom,map,garnison,etat)    VALUES('".$idCompte."','".$idAlliance."','".$nom."','".$map."','".serialize($garnison)."','".$etat."')";                      $GLOBALS['db']->query($sql);      $cpt=$GLOBALS['db']->query("SELECT LAST_INSERT_ID() as nb FROM j_hero " );    $compt = mysql_fetch_object($cpt);    return (int)$compt->nb;  }    function delet(){//suppresion du hero chargé    if($this->id > 0)    $GLOBALS['db']->query('DELETE FROM j_hero WHERE id = '.$this->id);    }    function suppression($id){//suppresion sans avoir chargé le hero    $GLOBALS['db']->query('DELETE FROM j_hero WHERE id = '.$id);  }    function init($x,$y)  {    $this->etat=1;    $this->X = $x;    $this->Y = $y;    $j=new Joueur;    $j->load($_SESSION['jid'],0,0,true);    $ally=new Alliance();    $ally->load($j->alliance);    $case=new CaseObject($x,$y,$this->map);      $case->ajouterHero($this->id,$j->login,$j->id,$ally->tag,$ally->id,$this->nom);    $case->save();  }    function calculDeplacement($x,$y,$X,$Y){ // Pythagore est dans la place    if($x>$X){      $xX = $x-$X;    }else{      $xX = $X-$x;    }    if($y>$Y){      $yY = $y-$Y;    }else{      $yY = $Y-$y;    }    $diag = sqrt( pow($xX,2) + pow($yY,2) ); // PythPyth         if(is_array($this->garnison->unite) AND is_object($this->garnison)){      $this->garnison->genererStats();    }        $time_classique = $diag*($GLOBALS['TempsCase']/$GLOBALS['vitesse']); // Diagonale * le temps de parcourir une case     $time = $time_classique+($time_classique/$this->garnison->caracs['vit']);    $time = round($time);    return $time;  }    function affiche($get){         print_r($this);                      //$case->ajouterVille(5,"Monster City","Alliance","Zatar City");             //$case->save();  // ajoutage de ville à la mano                       if($get['action']=="moveGo" AND $this->etat == 1){            $temps = $this->calculDeplacement($get['goX'],$get['goY'],$this->X,$this->Y);            $time_arrive = $temps + time();                        //************************************************************            // Case courante , on met l'état du héro en chemin pour une autre case            //************************************************************            $case = new CaseObject($this->X,$this->Y,$this->map);            $case->etatHero($this->id,3,$get['goX'],$get['goY'],$time_arrive);             //$case->enleverHero($this->id);            $case->save();            unset($case);                        //************************************************************            // Case d'arrivé , on met le héro dedans avec l'état en chemin             //************************************************************            $case = new CaseObject($get['goX'],$get['goY'],$this->map);                        $alliance = new Alliance();            $alliance->load($this->idAlliance);                        $joueur = new Joueur();            $joueur->load($this->idCompte);                        $case->ajouterHero($this->id,$joueur->login,$joueur->id,$alliance->tag,$joueur->alliance,$this->nom);            $case->etatHero($this->id,2,$this->X,$this->Y,$time_arrive);             //$case->enleverHero($this->id);            $case->save();            unset($case);                        $this->etat = 2;            $this->X = $get['goX'];            $this->Y = $get['goY'];            $this->temps = time()+$temps;                        //$action = new Action();            //$action->newAction('deplacement',$this->id,0,$temps);            $this->save();          }                              if($get['action']=="attaque" AND $this->etat == 1){                    if($this->surMaVille()==0){            $get['att'] = "att";          }          //echo $get['type'].'-->'.$get['id'];            $temps = $this->calculDeplacement($get['goX'],$get['goY'],$this->X,$this->Y);            $time_arrive = $temps + time();                        $case_enemis = new CaseObject($get['goX'],$get['goY'],$this->map);                            $action = 0;              if($get['type']=="h"){                if($case_enemis->hero[$get['id']]['etat'] != 1){                  $action = 1;                }              }                        if($action == 0){              //************************************************************              // Case courante , on met l'état du héro en chemin pour une autre case              //************************************************************              $case = new CaseObject($this->X,$this->Y,$this->map);              $case->etatHero($this->id,3,$get['goX'],$get['goY'],$time_arrive);               //$case->enleverHero($this->id);                $case->save();              unset($case);                            //************************************************************              // Case d'arrivé , on met le héro dedans avec l'état en chemin               //************************************************************              $case = new CaseObject($get['goX'],$get['goY'],$this->map);                            $alliance = new Alliance();              $alliance->load($this->idAlliance);                            $joueur = new Joueur();              $joueur->load($this->idCompte);                            $case->ajouterHero($this->id,$joueur->login,$joueur->id,$alliance->tag,$joueur->alliance,$this->nom);                            $case->etatHero($this->id,4,$this->X,$this->Y,$time_arrive,$get['type'],$get['id'],$get['att']);               //$case->enleverHero($this->id);              $case->save();              unset($case);                            $this->etat = 2;              $this->X = $get['goX'];              $this->Y = $get['goY'];              $this->temps = time()+$temps;                                                        //$action = new Action();              //$action->newAction('deplacement',$this->id,0,$temps);              $this->save();            }          }                	              $html = '<div class="contenu"><div class="contenu_header_fond">                      <div class="menu_hero">                          <span id="menu_hero_lien">'.ahref('<img src="./skin/original/texte/carte.png" alt="mon compte"/>','data.php?div=contenu&h='.$this->id.'&o=carte','contenu').'</span>                          <span id="menu_hero_lien">'.ahref('<img src="./skin/original/texte/unites.png" alt="forum de l\'alliance"/>','data.php?div=contenu&h='.$this->id.'&o=unite','contenu').'</span>                          <span id="menu_hero_lien">'.ahref('<img src="./skin/original/texte/inventaire.png" alt="forum général"/>','data.php?div=contenu&h='.$this->id.'&o=inventaire','contenu').'</span>                          <span id="menu_hero_lien">'.ahref('<img src="./skin/original/texte/options.png" alt="statistiques"/>','data.php?div=contenu&h='.$this->id.'&o=option','contenu').'</span>                      </div>                  </div>                  <div class="contenu_fond_centre">';                if(!isset($get['o'])){$get['o']= "aucun";}                switch($get['o']){                    case "unite":                            $html.= $this->garnison->AfficherUnite(1);                            break;                    case "inventaire":                                                           /*                            $this->garnison->AjoutUnite(2,4);*/                            //$this->save();                            $this->garnison->genererStats();                            if($this->niveau < $this->garnison->niveau){                            $niv_plus = $this->garnison->niveau-$this->niveau;                                                        $html.= 'Vous montez au niveau :'.$this->garnison->niveau.' niv +'.$niv_plus.'<br />';                              for($x=1;$x<=$niv_plus;$x++){                                $this->garnison->pCaracs+= POINT_DE_CARAC_PAR_NIVEAU;                              }                              $this->niveau+=$niv_plus;                              $this->save();                            }                            $this->garnison->GenererStats();                            //$html.= $GLOBALS['avant_textarea'];                                                        //$html.= $GLOBALS['apres_textarea'];                            $html.= '<div id="changeCaracs">';                            if($this->garnison->pCaracs>0){ // Si on a des points de caracs a dépensser                                $html.= $this->garnison->AfficherInventaire(1);                            }else{                                $html.= $this->garnison->AfficherInventaire(0);                            }                            $html.= '</div>';                           break;                                        case "option":                            $html.= '<table>  	                                     <tr><td>Tape le nouveau nom pour ton héro :</td></tr>                                     <tr><td><input id="newHeroName" class="inputText" name="newHeroName" maxlength="50" autocomplete="off" type="text" value="'.$this->nom.'"></td></tr>                                     <tr><td>&nbsp;<button class="search" type="submit" title="Search" onClick="sendFormNewHeroName()"></button></td></tr>                                  	 </tr>                                  	<tr><td><div id="returnPass"> </div></td></tr>	                                  	</table>';                            break;                                                case "detail":                            $case = new CaseObject($get['x'],$get['y'],$this->map);                            $html.=$case->afficheTout();                            break;                                                case "attaque":                                                $case = new CaseObject($get['x'],$get['y'],$this->map);                                                        $html.=$case->afficheTout($get['type'],$get['id']);                                                        //$html.= '<br />Sur ma ville ? '.$this->surMaVille().'<br />';                                                        if($get['type']== "v"){                            $html.="Attaquer : La ville ".$case->ville[$get['id']]['nom']." Coordonnées X:".$get['x']." Y:".$get['y']."  <br />";                            $html.="<br />Attaquer ";                            $html.= ahref(icoAttack(),'data.php?div=contenu&action=attaque&type=v&id='.$get['id'].'&goX='.$get['x'].'&goY='.$get['y'].'&att=att',"contenu");                            $html.= "<br />";                                                          if($this->surMaVille() == 1){                                $html.= "Pillage ";                                $html.= ahref(icoAttack(),'data.php?div=contenu&action=attaque&type=v&id='.$get['id'].'&goX='.$get['x'].'&goY='.$get['y'].'&att=pillage',"contenu");                                $html.= "<br />";                                                                $html.= "Destruction ";                                $html.= ahref(icoAttack(),'data.php?div=contenu&action=attaque&type=v&id='.$get['id'].'&goX='.$get['x'].'&goY='.$get['y'].'&att=dest',"contenu");                                $html.= "<br />";                                                                $html.= "Prise ";                                $html.= ahref(icoAttack(),'data.php?div=contenu&action=attaque&type=v&id='.$get['id'].'&goX='.$get['x'].'&goY='.$get['y'].'&att=prise',"contenu");                                $html.= "<br />";                              }else{                                $html.= "<br />Les modes Pillage, Destruction et Prise <br />ne peuvent être lancé que si ".$this->nom." est sur une de vos ville.";                              }                            }                                                        if($get['type']== "h"){                            $html.="Attaquer : Le Héro ".$case->hero[$get['id']]['nom']." Coordonnées X:".$get['x']." Y:".$get['y']."  <br />";                            $html.="<br />Attaquer ";                            $html.= ahref(icoAttack(),'data.php?div=contenu&action=attaque&type=h&id='.$get['id'].'&goX='.$get['x'].'&goY='.$get['y'].'&att=att',"contenu");                            $html.= "<br /><br />";                               if($this->surMaVille() == 1){                                  $html.= "Attaque & Retour ";                                  $html.= ahref(icoAttack(),'data.php?div=contenu&action=attaque&type=h&id='.$get['id'].'&goX='.$get['x'].'&goY='.$get['y'].'&att=attretour',"contenu");                                  $html.= "<br />";                               }else{                                  $html.= "Attaque avec retour ne peut être lancé que si ".$this->nom." se situe sur une de vos ville.";                               }                            }                            /*                            if(is_object(unserialize($case->combat)){                            $combat = unserialize($case->combat);                            $html.= $combat->afficherLog();                            }*/                            break;                    case 'nville' :                            $j=new Joueur();                            $j->load($_SESSION['jid']);                            $count = count($j->idVille);                            $html .='<div class="colo_ville"><img src="./skin/original/design/coloniser_ville.png" alt="coloniser la ville" />';                            $html .='<p><strong>ATTENTION</strong><br /><br />La colonisation de la ville entraine la perte du héro (les unités sur celui-ci seront transféré dans la nouvelle ville).</p><br /><br />';                                                         $html .= '<table><tr><td>Nom : </td></tr><tr><td><input type="input" class="inputText" id="nameVille" />&nbsp;</td></tr><td>';                                                               $html .='&nbsp;<button class="search" type="submit" title="Créer une Ville" onClick="sendFormNouvelleVille('.$get['x'].','.$get['y'].','.$get['h'].')"></button></td></tr></table></div>';                            $html .='<br /><div id="return"></div>';                                             break;                           default:                                         //$this->etat=1;                   // $this->save;                    //echo $this->etat;                            if(!isset($get['cc'])){                                    $x=$this->X;                                    $y=$this->Y;                            }else{                                    $x=$get['x'];                                    $y=$get['y'];                            }                            if($this->etat == 3){ // Il est en combat                            //print_r($this->etat);                                                                                      $case = new CaseObject($x,$y,$this->map);                              $case->verifHero();                              if(is_object($case->combat)){                                $html.= $case->combat->afficherCombat();                              }                              //print_r($case);                                                          }else{                                                          $zone = array($x,$y,4);                              $map = new Map($this->map,$zone);                              $map->loadMap();                              $html.= $map->affiche();                                   }                                                                                                          // $this->etat=1;                    //$this->save;                   // echo $this->etat;                      break;                }                               /* 	$data = print_r($this,true)	;                	$data2.= print_r($case,true)	;	$html.= "<pre>".$data.$data2."</pre>";*/	  $html.='</div><div class="contenu_fond_gauche"><div class="coordonnees"><img src="./skin/original/texte/coordonnees.png" alt="coordonnées"/></div><div class="coordonnee">X: '.$this->X.'</div><div class="coordonnee">Y: '.$this->Y.'</div>   <center><table align="center">      <tr><td colspan ="2" align="center">Aller A :</td></tr>      <tr><td>X  :</td><td><input id="Xgoto" class="inputSmallInt" name="Xgoto" maxlength="3" autocomplete="off" type="text" value="'.$get['tox'].'" onkeypress="if (event.keyCode == 13) {sendFormGoto();}"></td></tr>      <tr><td>Y  :</td><td><input id="Ygoto" class="inputSmallInt" name="Ygoto" maxlength="3" autocomplete="off" type="text" value="'.$get['toy'].'" onkeypress="if (event.keyCode == 13) {sendFormGoto();}"></td></tr>      <tr><td colspan ="2">&nbsp;<button class="search" type="submit" title="Envoyer" onClick="sendFormGoto()"></button></td></tr>      </table>  </center>  ';  if($this->etat == 1){             if( $get['tox'] == 0 AND $get['toy'] == 0){                $get['tox'] = $this->X;                $get['toy'] = $this->Y;             }             $html.= '<div align="center"><font size="2">';             if($get['tox'] != $this->X OR $get['toy'] != $this->Y){                                 //$html.= 'X:'.$get['tox'].'<br />Y:'.$get['toy'];                 if($this->etat==1){                   $temp = $this->calculDeplacement($get['tox'],$get['toy'],$this->X,$this->Y);                   $html.= '<br />Temps : <span>'.temp_seconde($temp).'</span><br />';                   $html.= ahref(icoGoto(),'data.php?div=contenu&action=moveGo&goX='.$get['tox'].'&goY='.$get['toy'],'contenu');                }             }             $html.= '</font></div>';  }   $html.='<div class="panel_actions"><img src="./skin/original/texte/panel_actions.png" alt="panel d\'actions"/></div><div class="tab_panel_actions">';			if($this->etat == 1){                        if(is_object($map)){                $html.= '<br />'.$map->afficheCase($get['tox'],$get['toy']);            }             $html.= '';        //  }                 }elseif($this->etat == 2){        $html.= "<b><h3>En déplacement</h3></b>";        $restant = $this->temps-time();        if($restant > 0){          $html .='Temps restant :<div id="timer'.$_SESSION['timer']++.'">'.temp_seconde($restant).'</div> ';        }else{          $html .='Déplacement terminé.';        }      }                  $html .='</div>					</div>      	      <div class="contenu_fond_droite">			<div class="unites"><img src="./skin/original/texte/unites.png" alt="mon compte"/></div>			<div class="unite"> Avec '.$this->nom.'<br /><br />';            if(is_object($this->garnison)){        $html.= $this->garnison->AfficherUnite();      }else{        $this->garnison = new Garnison();        $this->save();      }      $html.='</div>';      					$html.='</div></div>';		  		return $html;	  }    function surMaVille(){ // Return 1 oui , Return 0 Non  $case = new CaseObject($this->X,$this->Y,$this->map);    if(count($case->ville) > 0){ // Ya effectivement une ville      foreach($case->ville as $key => $ville){        if($ville['id_proprietaire'] == $this->idCompte){         return 1;        }      }    }    return 0;  }  }